Name:		qubes-u2f
Version:	@VERSION@
Release:	1%{?dist}
Summary:	Qubes OS U2F proxy

Group:		Qubes
License:	GPL2+
URL:		https://github.com/QubesOS/qubes-app-u2f
Source0:    %{name}-%{version}.tar.gz

BuildArch:  noarch
BuildRequires:	python%{python3_pkgversion}-devel
BuildRequires:	python%{python3_pkgversion}-sphinx
%{?systemd_requires}
BuildRequires:  make
BuildRequires:  systemd

Requires:	python%{python3_pkgversion}
Requires:	python%{python3_pkgversion}-u2flib-host
Requires:	python%{python3_pkgversion}-fido2

%description
Qubes OS U2F proxy

%prep
%setup -q

%build
make PYTHON=%{__python3}
make -C Documentation man SPHINXBUILD=sphinx-build-%{python3_version}

%install
make install \
    UNITDIR=%{_unitdir} \
    UDEVRULESDIR=%{_udevrulesdir} \
    DESTDIR=$RPM_BUILD_ROOT \
    PYTHON=%{__python3}

make -C Documentation install \
	MANDIR=%{_mandir} \
    DESTDIR=$RPM_BUILD_ROOT \
    PYTHON=%{__python3}

%post
%systemd_post qubes-u2fproxy.service

%preun
%systemd_preun qubes-u2fproxy.service

%postun
%systemd_postun_with_restart qubes-u2fproxy.service

%files
%doc
%{_mandir}/man8/qctap-*.8*

%{_bindir}/qctap-*
%{_sysconfdir}/qubes-rpc/ctap.ClientPin
%{_sysconfdir}/qubes-rpc/ctap.GetInfo
%{_sysconfdir}/qubes-rpc/ctap.MakeCredential
%{_sysconfdir}/qubes-rpc/ctap.GetAssertion
%{_sysconfdir}/qubes/post-install.d/30-qubes-u2f.sh

%{_presetdir}/75-qubes-u2fproxy.preset
%{_unitdir}/qubes-u2fproxy@.service
%{_unitdir}/qubes-u2fproxy.service
%{_udevrulesdir}/60-qu2f-hidraw.rules

%{python3_sitelib}/qubesu2f-%{version}-*.egg-info

%{python3_sitelib}/qubesu2f/__init__.py
%{python3_sitelib}/qubesu2f/__pycache__/*
%{python3_sitelib}/qubesu2f/const.py
%{python3_sitelib}/qubesu2f/ctap1.py
%{python3_sitelib}/qubesu2f/ctap2.py
%{python3_sitelib}/qubesu2f/protocol.py
%{python3_sitelib}/qubesu2f/util.py

%{python3_sitelib}/qubesu2f/client/__init__.py
%{python3_sitelib}/qubesu2f/client/__pycache__/*
%{python3_sitelib}/qubesu2f/client/hid_data.py
%{python3_sitelib}/qubesu2f/client/hidemu.py
%{python3_sitelib}/qubesu2f/client/qctap_proxy.py
%{python3_sitelib}/qubesu2f/client/uhid.py

%{python3_sitelib}/qubesu2f/sys_usb/__init__.py
%{python3_sitelib}/qubesu2f/sys_usb/__pycache__/*
%{python3_sitelib}/qubesu2f/sys_usb/mux.py
%{python3_sitelib}/qubesu2f/sys_usb/qctap_get_assertion.py
%{python3_sitelib}/qubesu2f/sys_usb/qctap_client_pin.py
%{python3_sitelib}/qubesu2f/sys_usb/qctap_get_info.py
%{python3_sitelib}/qubesu2f/sys_usb/qctap_make_credential.py
%{python3_sitelib}/qubesu2f/sys_usb/qctap_dump.py
